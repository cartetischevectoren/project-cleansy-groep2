#include "mbed.h"
#include "angledSonar.h"
#include <vector>

//inputs
Sonar Sonar_LinksVoor(D2, D3, -45, -12, 12, 0);
Sonar Sonar_Voor(D4, D5);
Sonar Sonar_RechtsVoor(D6, D7, 45, 12, 12, 0);
AnalogIn IR_LinksVoor(A0);
AnalogIn IR_Voor(A1);
AnalogIn IR_RechtsVoor(A2);
AnalogIn IR_RechtsAchter(A3);
AnalogIn IR_LinksAchter(A5);

//outputs
PwmOut enable(D10);
DigitalOut LV(D11);
DigitalOut LA(D12);
DigitalOut RV(D13);
DigitalOut RA(D14);

//vaste waardes
#define RPM 110
#define AANTAL_SONAR 3
#define AANTAL_IR 5
#define PWM_FREQ 1
#define PWM_DUTY 0.4f
#define WIELDIAMETER 95.0f
#define MIDDELPUNTSAFSTAND 17.5f
#define BANDMIDDENAFSTAND 131.0f
#define PI 3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632788659361533818279682303019520353018529689957736225994138912497217752834791315155748572424541506959508295331168617278558890750983817546374649393192550604009277016711390098488240128583616035637076601047101819429555961989467678374494482553797747268471040475346462080466842590694912933136770289891521047521620569660240580381501935112533824300355876402474964732639141992726042699227967823547816360093417216412199245863150302861829745557067498385054945885869269956909272107975093029553211653449872027559602364806654991198818347977535663698074265425278625518184175746728909777727938000816470600161452491921732172147723501414419735685481613611573525521334757418494684385233239073941433345477624168625189835694855620992192221842725502542568876717904946016534668049886272327917860857843838279679766814541009538837863609506800642251252051173929848960841284886269456042419652850222106611863067442786220391949450471237137869609563643719172874677646575739624138908658326459958133904780275900994657640789512694683983525957098258226205224894077267194782684826014769909026401363944374553050682034962524517493996514314298091906592509372216964615157098583874105978859597729754989301617539284681382686838689427741559918559252459539594310499725246808459872736446958486538367362226260991246080512438843904512441365497627807977156914359977001296160894416948685558484063534220722258284886481584560285060168427394522674676788952521385225499546667278239864565961163548862305774564980355936345681743241125150760694794510965960940252288797108931456691368672287489405601015033086179286809208747609178249385890097149096759852613655497818931297848216829989487226588048575640142704775551323796414515237462343645428584447952658678210511413547357395231134271661021359695362314429524849371871101457654035902799344037420073105785390621983874478084784896833214457138687519435064302184531910484810053706146806749192781911979399520614196634287544406437451237181921799983910159195618146751426912397489409071864942319615679452080951465502252316038819301420937621378559566389377870830390697920773467221825625996615014215030680384477345492026054146659252014974428507325186660021324340881907104863317346496514539057962685610055081066587969981635747363840525714591028970641401109712062804390397595156771577004203378699360072305587631763594218731251471205329281918261861258673215791984148488291644706095752706957220917567116722910981690915280173506712748583222871835209353965725121083579151369882091444210067510334671103141267111369908658516398315019701651511685171437657618351556508849099898599823873455283316355076479185358932261854896321329330898570642046752590709154814165498594616371802709819943099244889575712828905923233260972997120844335732654893823911932597463667305836041428138830320382490375898524374417029132765618093773444030707469211201913020330380197621101100449293215160842444859637669838952286847831235526582131449576857262433441893039686426243410773226978028073189154411010446823252716201052652272111660396665573092547110557853763466820653109896526918620564769312570586356620185581007293606598764861179104533488503461136576867532494416680396265797877185560845529654126654085306143444318586769751456614068007002378776591344017127494704205622305389945613140711270004078547332699390814546646458807972708266830634328587856983052358089330657574067954571637752542021149557615814002501262285941302164715509792592309907965473761255176567513575178296664547791745011299614890304639947132962107340437518957359614589019389713111790429782856475032031986915140287080859904801094121472213179476477726224142548545403321571853061422881375850430633217518297986622371721591607716692547487389866549494501146540628433663937900397692656721463853067360965712091807638327166416274888800786925602902284721040317211860820419000422966171196377921337575114959501566049631862947265473642523081770367515906735023507283540567040386743513622224771589150495309844489333096340878076932599397805419341447377441842631298608099888687413260472156951623965864573021631598193195167353812974167729478672422924654366800980676928238280689964004824354037014163149658979409243237896907069779422362508221688957383798623001593776471651228935786015881617557829735233446042815126272037343146531977774160319906655418763979293344195215413418994854447345673831624993419131814809277771038638773431772075456545322077709212019051660962804909263601975988281613323166636528619326686336062735676303544776280350450777235547105859548702790814356240145171806246436267945612753181340783303362542327839449753824372058353114771199260638133467768796959703098339130771098704085913374641442822772634659470474587847787201927715280731767907707157213444730605700733492436931138350493163128404251219256517980694113528013147013047816437885185290928545201165839341965621349143415956258658655705526904965209858033850722426482939728584783163057777560688876446248246857926039535277348030480290058760758251047470916439613626760449256274204208320856611906254543372131535958450687724602901618766795240616342522577195429162991930645537799140373404328752628889639958794757291746426357455254079091451357111369410911939325191076020825202618798531887705842972591677813149699009019211697173727847684726860849003377024242916513005005168323364350389517029893922334517220138128069650117844087451960121228599371623130171144484640903890644954440061986907548516026327505298349187407866808818338510228334508504860825039302133219715518430635455007668282949304137765527939751754613953984683393638304746119966538581538420568533862186725233402830871123282789212507712629463229563989898935821167456270102183564622013496715188190973038119800497340723961036854066431939509790190699639552453005450580685501956730229219139339185680344903982059551002263535361920419947455385938102343955449597783779023742161727111723643435439478221818528624085140066604433258885698670543154706965747458550332323342107301545940516553790686627333799585115625784322988273723198987571415957811196358330059408730681216028764962867446047746491599505497374256269010490377819868359381465741268049256487985561453723478673303904688383436346553794986419270563872931748723320837601123029911367938627089438799362016295154133714248928307220126901475466847653576164773794675200490757155527819653621323926406160136358155907422020203187277605277219005561484255518792530343513984425322341576233610642506390497500865627109535919465897514131034822769306247435363256916078154781811528436679570611086153315044521274739245449454236828860613408414863776700961207151249140430272538607648236341433462351897576645216413767969031495019108575984423919862916421939949072362346468441173940326591840443780513338945257423995082965912285085558215725031071257012668302402929525220118726767562204154205161841634847565169998116141010029960783869092916030288400269104140792886215078424516709087000699282120660418371806535567252532567532861291042487761825829765157959847035622262934860034158722980534989650226291748788202734209222245339856264766914905562842503912757710284027998066365825488926488025456610172967026640765590429099456815065265305371829412703369313785178609040708667114965583434347693385781711386455873678123014587687126603489139095620099393610310291616152881384379099042317473363948045759314931405297634757481193567091101377517210080315590248530906692037671922033229094334676851422144773793937517034436619910403375111735471918550464490263655128162288244625759163330391072253837421821408835086573917715096828874782656995995744906617583441375223970968340800535598491754173818839994469748676265516582765848358845314277568790029095170283529716344562129640435231176006651012412006597558512761785838292041974844236080071930457618932349229279650198751872127267507981255470958904556357921221033346697499235630254947802490114195212382815309114079073860251522742995818072471625916685451333123948049470791191532673430282441860414263639548000448002670496248201792896476697583183271314251702969234889627668440323260927524960357996469256504936818360900323809293459588970695365349406034021665443755890045632882250545255640564482465151875471196218443965825337543885690941130315095261793780029741207665147939425902989695946995565761218656196733786236256125216320862869222103274889218654364802296780705765615144632046927906821207388377814233562823608963208068222468012248261177185896381409183903673672220888321513755600372798394004152970028783076670944474560134556417254370906979396122571429894671543578468788614445812314593571984922528471605049221242470141214780573455105008019086996033027634787081081754501193071412233908663938339529425786905076431006383519834389341596131854347546495569781038293097164651438407007073604112373599843452251610507027056235266012764848308407611830130527932054274628654036036745328651057065874882256981579367897669742205750596834408697350201410206723585020072452256326513410559240190274216248439140359989535394590944070469120914093870012645600162374288021092764579310657922955249887275846101264836999892256959688159205600101655256375678566722796619885782794848855834397518744545512965634434803966420557982936804352202770984294232533022576341807039476994159791594530069752148293366555661567873640053666564165473217043903521329543529169414599041608753201868379370234888689479151071637852902345292440773659495630510074210871426134974595615138498713757047101787957310422969066670214498637464595280824369445789772330048764765241339075920434019634039114732023380715095222010682563427471646024335440051521266932493419673977041595683753555166730273900749729736354964533288869844061196496162773449518273695588220757355176651589855190986665393549481068873206859907540792342402300925900701731960362254756478940647548346647760411463233905651343306844953979070903023460461470961696886885014083470405460742958699138296682468185710318879065287036650832431974404771855678934823089431068287027228097362480939962706074726455399253994428081137369433887294063079261595995462624629707062594845569034711972996409089418059534393251236235508134949004364278527138315912568989295196427287573946914272534366941532361004537304881985517065941217352462589548730167600298865925786628561249665523533829428785425340483083307016537228563559152534784459818313411290019992059813522051173365856407826484942764411376393866924803118364453698589175442647399882284621844900877769776312795722672655562596282542765318300134070922334365779160128093179401718598599933849235495640057099558561134980252499066984233017350358044081168552653117099570899427328709258487894436460050410892266917835258707859512983441729535195378855345737426085902908176515578039059464087350612322611200937310804854852635722825768203416050484662775045003126200800799804925485346941469775164932709504934639382432227188515974054702148289711177792376122578873477188196825462981268685817050740272550263329044976277894423621674119186269439650671515779586756482399391760426017633870454990176143641204692182370764887834196896861181558158736062938603810171215855272668300823834046564758804051380801633638874216371406435495561868964112282140753302655100424104896783528588290243670904887118190909494533144218287661810310073547705498159680772009474696134360928614849417850171807793068108546900094458995279424398139213505586422196483491512639012803832001097738680662877923971801461343f

//globale variabelen
float draaiafstand = 0.015625f * PI * BANDMIDDENAFSTAND;
float afstandpm = RPM * PWM_DUTY * PI * WIELDIAMETER;
int msec_turn = draaiafstand / afstandpm * 60000;
float msec_turn_f = draaiafstand / afstandpm * 60000;
float LVMAX, LVMIN, RVMAX, RVMIN, VMAX, VMIN, LAMAX, LAMIN, RAMAX, RAMIN;
float stdLV, stdRV, stdV, stdLA, stdRA;

//timers
Timer intit;
Timer achter;

bool IR_test(float LVP, float LVM, float RVP, float RVM, float VP, float VM, float LAP, float LAM, float RAP, float RAM)
{
    float links = IR_LinksVoor.read();
    float voor = IR_Voor.read();
    float rechts = IR_RechtsVoor.read();
    float linksachter = IR_LinksAchter.read();
    float rechtsachter = IR_RechtsAchter.read();
    if(links < LVP && links > LVM && voor < VP && voor > VM && rechts < RVP && rechts > RVM && linksachter < LAP && linksachter > LAM && rechtsachter < RAP && rechtsachter > RAM){
        return false;
    }
    else{
        return true;
    }
}

bool IR_test2(float LVP, float LVM, float RVP, float RVM, float VP, float VM)
{
    float links = IR_LinksVoor.read();
    float voor = IR_Voor.read();
    float rechts = IR_RechtsVoor.read();
    if((links < LVP && links > LVM) && (voor < VP && voor > VM) && (rechts < RVP && rechts > RVM)){
        wait_ms(10);
        return true;
    }
    else{
        wait_ms(10);
        return false;
    }
}

bool IR_test3(float LVP, float LVM, float RVP, float RVM, float VP, float VM)
{
    float links = IR_LinksVoor.read();
    float voor = IR_Voor.read();
    float rechts = IR_RechtsVoor.read();
    LVP = LVP - stdLV;
    LVM = LVM + stdLV;
    RVP = RVP - stdRV;
    RVM = RVM + stdRV;
    VP = VP - stdV;
    VM = VM + stdV;
    if((links < LVP && links > LVM) && (voor < VP && voor > VM) && (rechts < RVP && rechts > RVM)){
        wait_ms(10);
        return true;
    }
    else{
        wait_ms(10);
        return false;
    }
}

float afstandLinks()
{
    float afstand;
    Point puntLV = Sonar_LinksVoor.getCoordinate(); //x en y van gedetecteerde object
    if(fabs(puntLV.getx()) > MIDDELPUNTSAFSTAND){
        //er is een afstand tussen de robot en het object
        afstand = fabs(puntLV.getx() + MIDDELPUNTSAFSTAND);
    }
    else{
        //er is geen afstand tussen de robot en het object
        afstand = 0 - (puntLV.getx() + MIDDELPUNTSAFSTAND);
    }
    return afstand;
}

float afstandRechts()
{
    float afstand;
    Point puntRV = Sonar_RechtsVoor.getCoordinate();
    afstand = puntRV.getx() - MIDDELPUNTSAFSTAND;
    return afstand;
}

float afstandVoor()
{
    float afstand = Sonar_Voor.getDistance();
    return afstand;
}

bool vrij()
{
    if(afstandLinks() <= 8 || afstandRechts() <= 8 || afstandVoor() <= 18){
        //indien objecten gedetecteerd is het niet meer vrij
        return false;
    }
    else{
        //vrij
        return true;
    }
}

void Rondje()
{
    intit.reset();
    intit.start();
    //timer om te bepalen of heel rondje gereden is
    LV = 1;
    RV = 0;
    LA = 0;
    RA = 1;
    //cw rondje rijden   
}

void Vooruit(float LVP, float LVM, float RVP, float RVM, float VP, float VM)
{
    bool vV = vrij();
    vV = IR_test2(LVP, LVM, RVP, RVM, VP, VM);
    while(vV == true){
        //zolang vrij is rijd hij vooruit
        vV = vrij();
        if(IR_test2(LVP, LVM, RVP, RVM, VP, VM) == false){
            break;
        }
        if(vV == true){
            RV = 1;
            LV = 1;
        }
    }
    RV = 0;
    LV = 0;
    //stop  
}

void Achteruit()
{
    achter.reset();
    achter.start();
    //timer voor achteruit
    while(achter.read_ms() < 800){
        //indien vrij is en niet langer dan een seconde achteruit rijd
        LA = 1;
        RA = 1;
    }
    //stop
    achter.stop();
    RA = 0;
    LA = 0;
}

void Linksaf(float sec)
{
    bool vL = !vrij();
    //zolang het niet vrij is om te rijden moet hij draaien
    RV = 1;
    LA = 1;
    while(vL == true){
        //draaien in stapjes
        wait_ms(sec);
        vL = !vrij();
    }
    //stop
    RV = 0;
    LA = 0;
}

void Rechtsaf(float sec)
{
    bool vR = !vrij();
    //zolang niet vrij is draaien
    RA = 1;
    LV = 1;
    while(vR == true){
        //draaien in stapjes
        wait_ms(sec);
        vR = !vrij();
    }
    //stop
    RA = 0;
    LV = 0;

}

int main()
{
    int initialize = 0; //initializatie nog niet geweest indien anders is hij al geweest
    enable.period_ms(PWM_FREQ);
    enable.write(PWM_DUTY);
    int turn = 0;   // 0 is rechts, 1 is links

    while(1){
        float SLinks = afstandLinks();
        float SRechts = afstandRechts();
        float SVoor = afstandVoor();
        //float SAchter = afstandAchter();

        if(initialize == 0){
            vector<float> waardeLV;
            vector<float> waardeV;
            vector<float> waardeRV;
            vector<float> waardeLA;
            vector<float> waardeRA;

            for(int i = 0; i < 1000; i++){
                waardeLV.push_back(IR_LinksVoor.read());
                waardeV.push_back(IR_Voor.read());
                waardeRV.push_back(IR_RechtsVoor.read());
                waardeLA.push_back(IR_LinksAchter.read());
                waardeRA.push_back(IR_RechtsAchter.read());
            }

            float sumLV, sumV, sumRV, sumLA, sumRA;

            for(int j = 0; j < 1000; j++){
                float IRLV = waardeLV[j];
                float IRV = waardeV[j];
                float IRRV = waardeRV[j];
                float IRLA = waardeLA[j];
                float IRRA = waardeRA[j];

                sumLV = sumLV + IRLV;
                sumV = sumV + IRV;
                sumRV = sumRV + IRRV;
                sumLA = sumLA + IRLA;
                sumRA = sumRA + IRRA;
            }

            float meanLV = sumLV / 1000;
            float meanV = sumV / 1000;
            float meanRV = sumRV / 1000;
            float meanLA = sumLA / 1000;
            float meanRA = sumRA / 1000;

            float sumLV2, sumV2, sumRV2, sumLA2, sumRA2;
            for(int k = 0; k < 1000; k++){
                float IRLV = waardeLV[k];
                float IRV = waardeV[k];
                float IRRV = waardeRV[k];
                float IRLA = waardeLA[k];
                float IRRA = waardeRA[k];

                sumLV2 = sumLV2 + pow((IRLV - meanLV), 2);
                sumV2 = sumV2 + pow((IRV - meanV), 2);
                sumRV2 = sumRV2 + pow((IRRV - meanRV), 2);
                sumLA2 = sumLA2 + pow((IRLA - meanLA), 2);
                sumRA2 = sumRA2 + pow((IRRA - meanRA), 2);

            }
            stdLV = sqrt(sumLV2 / 1000);
            stdV = sqrt(sumV2 / 1000);
            stdRV = sqrt(sumRV2 / 1000);
            stdLA = sqrt(sumLA2 / 1000);
            stdRA = sqrt(sumRA2 / 1000);

            LVMAX = meanLV + 2* stdLV;
            LVMIN = meanLV - 2*stdLV;
            VMAX = meanV +  2*stdV;
            VMIN = meanV - 2*stdV;
            LAMAX = meanLA + 2*stdLA;
            LAMIN = meanLA - 2*stdLA;
            RVMAX = meanRV + 2*stdRV;
            RVMIN = meanRV - 2*stdRV;
            RAMAX = meanRA +  2*stdRA;
            RAMIN = meanRA -  2*stdRA;

            //initialisatie
            Rondje(); //cw rondje rijden
            bool SL, SR, SV, IR, check; //sonar check
            check = true;
            IR = false;
            while(check){
                printf("\r\n fase 4");
                if(IR == false){
                    IR = IR_test(LVMAX, LVMIN, RVMAX, RVMIN, VMAX, VMIN, LAMAX, LAMIN, RAMAX, RAMIN);
                }
                //printf("%f %f %f \r\n", afstandLinks(), afstandRechts(), afstandVoor());
                if(afstandLinks() < (SLinks - 10) || afstandLinks() > (SLinks + 10)){
                    SL = true;
                }
                if(afstandRechts() < (SRechts - 10) || afstandRechts() > (SRechts + 10)){
                    SR = true;
                }
                if(afstandVoor() < (SVoor - 10) || afstandVoor() > (SVoor + 10)){
                    SV = true;
                }
                //if(afstandAchter() < (SAchter - 10) || afstandAchter() > (SAchter + 10)){ SA = true; }
                if(SL == true && SR == true && SV == true && IR == true){
                    check = false;
                }
            }
            printf("\r\n fase 5");
            int tijd = intit.read_ms();//heel rondje?
            while(fmod(tijd, (128 * msec_turn_f)) > 10){
                tijd = intit.read_ms();
                wait_ms(10);
            }
            //stop
            intit.stop();
            LV = 0;
            RA = 0;
            wait_ms(1000);
            //rechtsaf 90 graden
            LV = 1;
            RA = 1;
            wait_ms(msec_turn * 32);
            LV = 0;
            RA = 0;
            Vooruit(LVMAX, LVMIN, RVMAX, RVMIN, VMAX, VMIN);
            wait_ms(50);
            //linksaf 90 graden
            LA = 1;
            RV = 1;
            wait_ms(msec_turn * 32);
            //stop
            LA = 0;
            RV = 0;
            initialize = 1;//einde initialisatie
        }
        if(IR_test2(LVMAX, LVMIN, RVMAX, RVMIN, VMAX, VMIN) == false){
            Achteruit();
            LA = 1;
            RV = 1;
            wait_ms(msec_turn * 32);
            LA = 0;
            RV = 0;
            /*float links = IR_LinksVoor.read();
            float voor = IR_Voor.read();
            float rechts = IR_RechtsVoor.read();
            float linksachter = IR_LinksAchter.read();
            float rechtsachter = IR_RechtsAchter.read();
            if((voor < VMIN || voor > VMAX) || (rechts < RVMIN || rechts > RVMAX) || (links > LVMAX || links < LVMIN) && ((linksachter < LAMIN || linksachter > LAMAX) && (rechtsachter < RAMIN || rechtsachter > RAMAX))){
                wait(20);
                while(IR_test2(LVMAX, LVMIN, RVMAX, RVMIN, VMAX, VMIN) == false){
                    LV = 0;
                    LA = 0;
                    RV = 0;
                    RA = 0;
                }
            }
            else if((rechts < RVMIN || rechts > RVMAX) && (links < LVMAX && links > LVMIN)){
                Achteruit();
                LA = 1;
                RV = 1;
                wait_ms(msec_turn * 32);
                LA = 0;
                RV = 0;
            }
            else if((voor < VMIN || voor > VMAX) && (linksachter > LAMIN && linksachter < LAMAX) && (rechtsachter > RAMIN && rechtsachter < RAMAX)){
                Achteruit();
                LA = 0;
                RA = 0;
                LV = 1;
                RA = 1;
                wait_ms(msec_turn * 16);
                //stop
                LV = 0;
                RA = 0;
            }
            else if((links > LVMAX || links < LVMIN) && (rechts < RVMAX && rechts > RVMIN)){
                Achteruit();
                LV = 1;
                RA = 1;
                wait_ms(msec_turn * 32);
                LV = 0;
                RA = 0;
            }
            else{
                Achteruit();
                LV = 1;
                RA = 1;
                wait_ms(msec_turn * 16);
                //stop
                LV = 0;
                RA = 0;
            }*/
        }
        else if(afstandLinks() <= 8 && afstandRechts() > 8){
            //links geen ruimte rechts wel
            Rechtsaf(msec_turn);
            turn = 0;
        }
        else if(afstandRechts() <= 8 && afstandLinks() > 8){
            //rechts geen ruimte links wel
            Linksaf(msec_turn);
            turn = 1;
        }
        else if(afstandLinks() <= 8 && afstandRechts() <= 8){
            //Achteruit();
            //180 graden draaien cw
            LV = 1;
            RA = 1;
            wait_ms(msec_turn * 16);
            //stop
            LV = 0;
            RA = 0;
        }
        else{
            if(turn == 0){
                //indien vorige keer rechtsaf nu linksaf
                Linksaf(msec_turn);
                turn = 1;
            }
            else{
                //indien vorige keer linksaf nu rechtsaf
                Rechtsaf(msec_turn);
                turn = 0;
            }

        }
        Vooruit(LVMAX, LVMIN, RVMAX, RVMIN, VMAX, VMIN);

    }
}
